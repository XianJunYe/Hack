<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Recorder</title>
</head>
<body>
<h1>Audio Recorder</h1>
<button id="startBtn">Start Recording</button>
<button id="stopBtn">Stop Recording</button>

<h1>播放音频</h1>
<button id="playAudio">播放音频</button>

<script>
    let mediaRecorder;
    let socket;

    document.getElementById("startBtn").onclick = async () => {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        socket = new WebSocket('ws://localhost:8080');

        mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0 && socket.readyState === WebSocket.OPEN) {
                socket.send(event.data);
            }
        };

        mediaRecorder.start(100); // 每100ms发送一次数据
    };


    document.getElementById("playAudio").onclick = async () => {
        const context = new (window.AudioContext || window.webkitAudioContext)();
        const socket = new WebSocket("ws://localhost:8080/audio");

        let audioData = [];

        socket.onmessage = (event) => {
            audioData.push(event.data); // 收集数据块
        };

        socket.onopen = () => {
            console.log("WebSocket connection established.");
        };

        socket.onclose = () => {
            console.log("WebSocket connection closed.");
            // 将接收到的音频数据合并并播放
            const blob = new Blob(audioData, { type: 'audio/wav' });
            const arrayBuffer = new Response(blob).arrayBuffer();
            arrayBuffer.then(buffer => {
                context.decodeAudioData(buffer, (audioBuffer) => {
                    const source = context.createBufferSource();
                    source.buffer = audioBuffer;
                    source.connect(context.destination);
                    source.start();
                });
            });
        };
    };

    document.getElementById("stopBtn").onclick = () => {
        mediaRecorder.stop();
        socket.close();
    };
</script>
</body>
</html>